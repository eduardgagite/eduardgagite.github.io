---
title: "Rate Limiting"
category: "redis"
categoryTitle: "Redis"
section: "patterns"
sectionTitle: "Паттерны и практические кейсы"
sectionOrder: 3
order: 2
---

Rate limiting — это ограничение числа операций за промежуток времени. Чаще всего его используют, чтобы защитить API, формы логина и другие чувствительные точки от злоупотреблений.

Идея простая: считать события (запросы, попытки входа) и не давать делать их слишком часто.

## Простой лимит: не больше N запросов за окно

Классический пример: не больше 10 запросов в минуту с одного пользователя или IP.

В качестве ключа можно взять что‑то вроде:

```
rate:login:ip:127.0.0.1
```

Каждый запрос увеличивает счётчик и задаёт срок жизни ключа:

```
INCR rate:login:ip:127.0.0.1
EXPIRE rate:login:ip:127.0.0.1 60
```

Логика в приложении:

1. Увеличить счётчик через INCR.
2. Если это первый запрос (ответ 1) — задать время жизни через EXPIRE.
3. Если значение счётчика больше порога (например, 10) — вернуть ошибку «слишком много запросов».

Так получается простое «окно» на 60 секунд: после паузы счётчик сам обнуляется.

## Болеe ровный лимит: скользящее окно на ZSET

Фиксированное окно иногда даёт «скачки»: пользователь может сделать почти 2× лимита на границе минут. Чтобы сгладить это, используют скользящее окно на упорядоченном множестве.

Ключ для пользователя:

```
rate:api:user:42
```

При каждом запросе берём текущий timestamp (например, в миллисекундах) и выполняем последовательность команд:

1. Добавить метку времени в ZSET.
2. Удалить из ZSET все записи старше окна (например, старше 60 секунд).
3. Посчитать, сколько записей осталось.

Пример команд:

```
ZADD rate:api:user:42 1710000000000 "req1"
ZREMRANGEBYSCORE rate:api:user:42 -inf 1709999940000
ZCARD rate:api:user:42
```

Если ZCARD показывает, что запросов больше лимита, новый запрос отклоняется.

**Плюсы такого подхода:** более честное ограничение «N запросов за последние X секунд», а не за календарную минуту.

## Что именно ограничивать

В качестве части ключа для лимита можно использовать:

- идентификатор пользователя;
- IP‑адрес;
- комбинацию метода и пути API;
- любое другое значение, которое нужно защитить.

Примеры ключей:

```
rate:api:user:42
rate:api:ip:10.0.0.1
rate:login:user:42
```

Главное — чтобы по ключу было понятно, что именно вы ограничиваете.

## Итого

**Rate limiting на Redis** сводится к двум идеям:

- простой счётчик с TTL для грубого лимита «N запросов за окно»;
- упорядоченное множество с метками времени для более ровного скользящего окна.

Дальше всё зависит от логики приложения: где именно вы добавляете запрос в счётчик и как обрабатываете ситуацию, когда лимит превышен.
