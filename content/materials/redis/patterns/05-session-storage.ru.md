---
title: "Хранение сессий"
category: "redis"
categoryTitle: "Redis"
section: "patterns"
sectionTitle: "Паттерны и практические кейсы"
sectionOrder: 3
order: 5
---

Хранение сессий в Redis позволяет быстро проверять, авторизован ли пользователь, и не нагружать основную базу лишними запросами. Сессия связывает случайный токен с информацией о пользователе и временем жизни.

## Зачем хранить сессии в Redis

**Redis** хорошо подходит для сессий, потому что:

**Быстро.** Проверка токена — это один запрос к памяти.

**Есть TTL.** Срок действия сессии задаётся автоматически и не требует ручной очистки.

**Удобно масштабировать.** Несколько экземпляров приложения могут работать с одним Redis и видеть одни и те же сессии.

## Простая схема сессии

Обычно сессия выглядит так:

- у пользователя есть случайный токен, который хранится в cookie или заголовке;
- по этому токену в Redis лежит информация о пользователе.

Пример ключа для сессии:

```
session:token:abc123
```

Внутри можно хранить:

- идентификатор пользователя (**user_id**);
- нужные флаги (например, **is_admin**);
- время создания, если требуется.

В Redis это можно записать строкой (JSON) или хешем. Простейший вариант со строкой и временем жизни 30 минут:

```
SETEX session:token:abc123 1800 "{\"user_id\":42}"
```

## Создание сессии при логине

Последовательность шагов при успешном входе:

1. Проверить логин и пароль в основной базе.
2. Сгенерировать случайный токен.
3. Сохранить сессию в Redis с TTL.
4. Отдать токен клиенту.

Пример записи сессии в виде хеша:

```
HSET session:token:abc123 user_id 42
EXPIRE session:token:abc123 1800
```

Клиент получает токен **abc123** и отправляет его с каждым запросом (через cookie или заголовок).

## Проверка сессии при запросе

На каждом запросе сервер:

1. Достаёт токен из cookie или заголовка.
2. Проверяет, есть ли такая сессия в Redis.
3. Если сессия найдена — считает пользователя авторизованным.

Пример проверки:

```
HGET session:token:abc123 user_id
```

Если Redis вернул значение, можно считать, что пользователь вошёл. Если пусто — сессия истекла или никогда не существовала.

Иногда при каждом запросе с TTL делают «продление» сессии:

```
EXPIRE session:token:abc123 1800
```

Так время жизни сдвигается вперёд, пока пользователь активен.

## Выход из аккаунта

При выходе из аккаунта достаточно удалить запись о сессии:

```
DEL session:token:abc123
```

После этого токен больше не будет найден, и следующий запрос с этим токеном будет считаться неавторизованным.

Если у пользователя много одновременных сессий (несколько устройств), можно делать ключи вида:

```
session:user:42:device:phone
session:user:42:device:laptop
```

И удалять только нужную сессию или сразу все, если требуется принудительный выход везде.

## Итого

**Сессии в Redis** — это связка «токен → данные пользователя с TTL». Приложение быстро проверяет токен, не ходит лишний раз в основную базу и может гибко управлять сроком жизни авторизации.

