---
title: "Настройки персистентности и бэкапы"
category: "redis"
categoryTitle: "Redis"
section: "persistence"
sectionTitle: "Персистентность данных"
sectionOrder: 6
order: 4
---

Даже зная разницу между **RDB** и **AOF**, легко запутаться в реальных настройках: как часто делать snapshot, какой режим **appendfsync** выбрать, куда складывать файлы и как организовать бэкапы.

Задача этого раздела — дать практичные схемы настройки персистентности под разные сценарии и показать простые приёмы резервного копирования Redis.

## Базовые настройки персистентности

Проверить текущие параметры можно так:

```
CONFIG GET save
CONFIG GET appendonly
CONFIG GET appendfsync
CONFIG GET dir
CONFIG GET dbfilename
CONFIG GET appendfilename
```

Эти команды показывают:

- расписание snapshot (**save**);
- включён ли AOF (**appendonly**);
- частоту fsync для AOF (**appendfsync**);
- каталог и имена файлов для RDB и AOF.

Менять настройки на лету можно через **CONFIG SET**, но для долгосрочных конфигураций лучше фиксировать их в redis.conf и держать под контролем через систему управления конфигурациями.

## Сценарий: Redis как кэш

Если Redis используется только как кэш, основной источник данных находится в другой базе, а потеря содержимого Redis не критична.

Практичная схема:

- отключить snapshot и AOF;
- настроить лимит памяти и политику вытеснения.

Пример:

```
CONFIG SET save ""
CONFIG SET appendonly no

CONFIG SET maxmemory 2gb
CONFIG SET maxmemory-policy allkeys-lru
```

В этом режиме Redis не делает дисковые записи ради персистентности, работает максимально быстро, а восстановление после перезапуска сводится к прогреву кэша из основного хранилища.

## Сценарий: Redis хранит важные данные

Если Redis хранит сессии, очереди задач или бизнес‑данные, которые терять нельзя, имеет смысл включить и RDB, и AOF.

Пример настроек:

```
save 900 1
save 300 10
save 60 10000

appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
```

Важные моменты:

- **appendfsync everysec** даёт баланс между скоростью и надёжностью;
- snapshot по **save** создают регулярные RDB‑файлы, удобные для бэкапов;
- лог AOF позволяет восстановиться почти до момента сбоя.

Дополнительно стоит включить репликацию на резервный инстанс и следить за временем выполнения BGSAVE и BGREWRITEAOF по метрикам.

## Простые бэкапы RDB и AOF

Бэкап Redis сводится к копированию файлов RDB и, при необходимости, AOF.

Алгоритм для RDB:

1. Убедиться, что snapshot свежий (при необходимости вызвать **BGSAVE**).
2. Подождать завершения сохранения (по логам или метрикам).
3. Скопировать файл **dump.rdb** в безопасное хранилище.

Пример ручной последовательности:

```
BGSAVE
```

после завершения:

```
cp /var/lib/redis/dump.rdb /backups/redis/dump-2025-11-23.rdb
```

Если используется AOF:

1. Убедиться, что нет активного BGREWRITEAOF.
2. При желании запустить **BGREWRITEAOF**, чтобы получить компактный файл.
3. Скопировать **appendonly.aof** в хранилище бэкапов.

В продакшене эти шаги обычно автоматизируют скриптами и кронами или средствами оркестрации.

## Практические советы по персистентности

Несколько правил, которые часто спасают от проблем:

- выбирать режимы персистентности под конкретный сценарий, а не «на всякий случай всё включить»;
- не запускать **SAVE** на больших базах, использовать только **BGSAVE**;
- не забывать про влияние RDB и AOF на память и диск при настройке **maxmemory**;
- регулярно проверять, что файлы RDB и AOF реально попадают в внешние бэкапы;
- периодически тестировать восстановление на отдельном стенде, а не надеяться, что всё заработает само.

## Итог

Настройки персистентности в **Redis** — это компромисс между скоростью, надёжностью и простотой эксплуатации.

Если осознанно выбирать между режимами «только кэш», «критичные данные» и гибридными схемами, а бэкапы делать и проверять регулярно, Redis остаётся предсказуемым и надёжным даже в сложных продакшен‑окружениях.


