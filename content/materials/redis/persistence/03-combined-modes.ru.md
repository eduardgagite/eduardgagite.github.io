---
title: "Комбинированные режимы RDB + AOF"
category: "redis"
categoryTitle: "Redis"
section: "persistence"
sectionTitle: "Персистентность данных"
sectionOrder: 6
order: 3
---

В реальных системах редко ограничиваются только RDB или только AOF. Чаще всего их комбинируют: RDB даёт быстрый старт с готовым снимком, а AOF добавляет поверх почти непрерывный журнал изменений.

Такой гибридный режим позволяет ускорить запуск, повысить надёжность и иметь два независимых источника восстановления.

## Как Redis сочетает RDB и AOF

Когда включены оба механизма:

- Redis периодически делает RDB‑snapshot (по настройкам **save**);
- параллельно каждое изменение записывается в **AOF**;
- при запуске сервер по умолчанию сначала пытается загрузить AOF, а если его нет или он повреждён — использует RDB.

Порядок загрузки можно проверить и настроить в конфиге, но общая идея проста: AOF считается более «свежим» источником, потому что хранит последние команды.

## Типичная схема: RDB для бэкапов, AOF для минимума потерь

Один из рабочих вариантов:

1. Оставить включённые snapshot через **save** для периодических RDB‑файлов.
2. Включить AOF с режимом **appendfsync everysec**.
3. Настроить автоматическую перепаковку AOF.

Конфигурация будет выглядеть примерно так:

```
save 900 1
save 300 10
save 60 10000

appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
```

В этом режиме:

- RDB‑файлы удобно использовать для бэкапов и переноса данных;
- AOF даёт возможность восстановиться почти до момента сбоя с потерей максимум одной секунды изменений.

## Оптимизация запуска: AOF поверх RDB

Для очень больших баз запуск только по AOF может быть медленным: Redis нужно прочитать и выполнить большой журнал команд. Чтобы ускорить старт, есть механизм создания «сложного» AOF на основе snapshot.

Схема работы:

1. Redis делает RDB‑snapshot.
2. Этот snapshot конвертируется в AOF‑формат как набор начальных команд.
3. Поверх него продолжается обычный лог AOF.

Команды управления зависят от конкретной версии Redis, но общая идея в том, чтобы:

- хранить компактное начальное состояние (аналог RDB);
- иметь короткий хвост AOF с последними изменениями.

Это уменьшает время запуска и размер файла, сохраняя при этом семантику журнала команд.

## Когда комбинированный режим оправдан

Имеет смысл включать оба механизма, когда:

- Redis хранит данные, потеря которых нежелательна;
- нужен удобный способ регулярно забирать снимки для бэкапов;
- объём данных достаточно большой, чтобы волноваться о времени старта и размере AOF.

Вместе с этим:

- растёт нагрузка на диск (snapshot + журнал);
- нужно внимательно следить за настройками памяти и частотой BGSAVE и BGREWRITEAOF;
- важно мониторить время выполнения фоновых операций, чтобы они не пересекались в самый неудачный момент.

Если же Redis используется как чистый кэш, а потеря данных при перезапуске некритична, комбинированный режим чаще всего избыточен — достаточно настроить политику вытеснения и, при необходимости, отдельные RDB‑snapshot для диагностики.

## Итог

Комбинация **RDB + AOF** даёт более гибкий и надёжный вариант персистентности: быстрый старт с готовым снимком и минимальную потерю данных за счёт журнала команд.

Важно подобрать частоту snapshot, режим **appendfsync** и стратегию перепаковки AOF так, чтобы баланс между надёжностью, скоростью и нагрузкой на диск соответствовал реальным требованиям проекта.


