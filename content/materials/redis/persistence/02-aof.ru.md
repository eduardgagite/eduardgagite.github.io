---
title: "AOF: журнал команд"
category: "redis"
categoryTitle: "Redis"
section: "persistence"
sectionTitle: "Персистентность данных"
sectionOrder: 6
order: 2
---

Режим **AOF** (Append Only File) записывает каждую команду изменения данных в журнал на диск. При перезапуске Redis читает этот журнал и «проигрывает» команды заново, восстанавливая состояние почти до момента сбоя.

За счёт этого AOF даёт более надёжную персистентность, чем одни только RDB‑снимки, но требует аккуратных настроек и периодической перепаковки файла.

## Как устроен AOF

Когда AOF включён, Redis:

1. При каждом изменении данных дописывает команду в AOF‑файл.
2. Периодически «сбрасывает» буфер на диск в зависимости от настроек синхронизации.
3. В фоне может переписывать файл, убирая из него лишние старые команды.

Основные настройки можно посмотреть так:

```
CONFIG GET appendonly
CONFIG GET appendfilename
CONFIG GET appendfsync
```

Если **appendonly** равен yes, то режим AOF включён. Имя файла по умолчанию — **appendonly.aof**.

## Настройка частоты fsync

Ключевой параметр, влияющий на надёжность и производительность, — **appendfsync**. Он определяет, как часто Redis будет вызывать fsync для записи данных на диск.

Варианты:

```
CONFIG SET appendfsync always
CONFIG SET appendfsync everysec
CONFIG SET appendfsync no
```

Смысл:

- **always** — fsync после каждой команды. Максимальная надёжность, но может сильно замедлить запись.
- **everysec** — fsync раз в секунду. Компромисс: в худшем случае теряется около секунды данных.
- **no** — Redis полагается на буферы ОС. Быстро, но потеря последних изменений при сбое может быть больше.

На практике чаще всего выбирают **everysec** как баланс между безопасностью и скоростью.

## Включение AOF на живом инстансе

Если AOF был выключен, его можно включить без остановки сервера:

```
CONFIG SET appendonly yes
```

Redis:

1. Создаст начальный AOF‑файл на основе текущего состояния (под капотом использует RDB + преобразование в набор команд).
2. Начнёт дописывать новые команды в файл.

Этот процесс может занять время и временно увеличить нагрузку на диск и память, поэтому включать AOF лучше в спокойный период.

## Перепаковка AOF (AOF rewrite)

Со временем AOF‑файл растёт, потому что в нём остаются старые команды, которые много раз перезаписывали одни и те же ключи. Чтобы файл не раздувался бесконечно, Redis умеет переписывать его в компактный вариант.

Явный запуск перепаковки:

```
BGREWRITEAOF
```

Redis:

1. Создаёт новый временный AOF‑файл с «сжатым» набором команд.
2. В момент переключения аккуратно заменяет старый файл новым.

Типичный пример:

- старый файл содержит множество SET одного и того же ключа;
- новый файл будет содержать только один последний SET, который даёт то же итоговое состояние.

Перепаковка может запускаться автоматически при росте файла, если настроены соответствующие параметры в конфиге.

## Когда AOF уместен

Режим AOF хорошо подходит, когда:

- важна минимальная потеря данных при сбое;
- Redis хранит критичную бизнес‑информацию, а не только кэш;
- нужно иметь детальный журнал операций для отладки или анализа.

Нужно учитывать:

- AOF создаёт дополнительную нагрузку на диск;
- при некорректных настройках appendfsync запись может стать узким местом;
- при очень высоких нагрузках на запись иногда используют отдельные инстансы под AOF и под кэш.

Часто AOF комбинируют с RDB, чтобы ускорить запуск и иметь два независимых источника восстановления.

## Итог

**AOF** превращает Redis в систему с почти непрерывной персистентностью: каждая команда записывается в журнал и может быть воспроизведена после перезапуска.

Грамотный выбор режима **appendfsync**, регулярная перепаковка AOF‑файла и понимание нагрузок на диск позволяют использовать этот механизм без ощутимого удара по производительности.


