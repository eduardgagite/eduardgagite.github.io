---
title: "Работа со snapshot и RDB-файлами"
category: "redis"
categoryTitle: "Redis"
section: "memory"
sectionTitle: "Управление памятью"
sectionOrder: 5
order: 4
---

Помимо оперативной памяти, **Redis** умеет сохранять снимки данных на диск в виде **RDB-файлов**. Это нужно, чтобы после перезапуска восстановить состояние базы или иметь резервную копию. Но создание snapshot тоже влияет на память и нагрузку, особенно при больших объёмах данных.

Важно понимать, как запускается сохранение, где лежат файлы и какие подводные камни есть у ручного и автоматического snapshot.

## Где лежат RDB-файлы

Настройки сохранения находятся в конфиге или меняются через **CONFIG**.

Посмотреть имя файла и каталог:

```
CONFIG GET dbfilename
CONFIG GET dir
```

Обычно результат будет вроде:

```
dbfilename dump.rdb
dir /var/lib/redis
```

Это значит, что snapshot сохраняется в файл **dump.rdb** в указанной директории. Файл можно потом скопировать как резервную копию или перенести на другой сервер.

## SAVE и BGSAVE — как запустить snapshot

Есть два способа явно создать RDB-файл.

Синхронное сохранение:

```
SAVE
```

Redis блокирует обработку команд, пока полностью не запишет snapshot на диск. На продакшене это почти всегда плохой вариант: запросы будут простаивать, а задержки вырастут.

Асинхронное сохранение:

```
BGSAVE
```

В этом режиме:

- Redis делает fork процесса;
- дочерний процесс пишет snapshot на диск;
- основной продолжает обрабатывать команды.

Именно **BGSAVE** обычно используется по умолчанию в автоматических настройках сохранения.

## Автоматические snapshot и их влияние

В конфиге Redis часто можно увидеть строки вида:

```
save 900 1
save 300 10
save 60 10000
```

Это означает:

- если за 900 секунд был хотя бы 1 запрос на изменение данных — сделать snapshot;
- если за 300 секунд было 10 изменений — тоже сохранить;
- если за 60 секунд было 10000 изменений — снова сохранить.

При каждом таком срабатывании Redis будет запускать **BGSAVE**, то есть делать копию данных в памяти и писать её на диск. Для небольших инстансов это дёшево, но при десятках гигабайт данных:

- возрастает потребление памяти из‑за copy-on-write;
- возможны короткие пики нагрузки на диск;
- время BGSAVE может стать заметным.

Если Redis используется как чистый кэш и потеря данных допустима, автоматические snapshot часто отключают:

```
CONFIG SET save ""
```

В этом режиме RDB-файлы не создаются, а объём памяти и нагрузка на диск предсказуемее.

## Snapshot и память: что важно учитывать

При запуске **BGSAVE** Redis делает fork процесса. Операционная система использует механизм copy-on-write: страницы памяти копируются только при изменении. Но если в момент snapshot идёт активная запись, реальное потребление памяти может заметно вырасти.

Практические рекомендации:

- не запускать **SAVE** на больших базах в продакшене;
- планировать **BGSAVE** на спокойные периоды с меньшим количеством записей;
- учитывать запас памяти на сервере, если объём данных в Redis уже близок к лимиту.

Если лимит памяти и политики вытеснения настроены агрессивно, а snapshot включён часто, можно неожиданно уткнуться в недостаток RAM во время BGSAVE.

## Итог

Snapshot и **RDB-файлы** позволяют сохранять состояние Redis на диск и поднимать сервис после перезапуска без потери данных.

Правильная настройка интервалов сохранения и выбор между «Redis как кэш» (с отключёнными snapshot) и «Redis как часть основного хранилища» помогают выдержать баланс между надёжностью, потреблением памяти и нагрузкой на диск.


