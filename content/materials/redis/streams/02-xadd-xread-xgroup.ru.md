---
title: "XADD, XREAD, XGROUP"
category: "redis"
categoryTitle: "Redis"
section: "streams"
sectionTitle: "Redis Streams"
sectionOrder: 4
order: 2
---

В основе работы с **Redis Streams** лежат три команды: **XADD** для записи сообщений, **XREAD** для чтения и **XGROUP** для создания и управления группами потребителей. На практике этого уже достаточно, чтобы построить простую очередь задач или обработку событий между сервисами.

Разберём, как они работают на реальных примерах: от простого «написать и прочитать» до подготовки потока к использованию с группами.

## XADD — добавление сообщений в поток

Команда **XADD** добавляет новое сообщение в конец потока. Минимальный вариант:

```
XADD orders:stream * user_id 123 status "created" amount 1000
```

Что здесь происходит:

- создаётся поток **orders:stream**, если его ещё нет;
- символ звёздочки говорит Redis сгенерировать идентификатор автоматически;
- дальше идут пары поле–значение: **user_id 123**, **status "created"**, **amount 1000**.

В ответ Redis вернёт идентификатор сообщения, например:

```
"1698249601-0"
```

Если нужно ограничивать размер потока, можно сразу включить обрезку:

```
XADD orders:stream MAXLEN 1000 * user_id 123 status "created" amount 1000
```

В этом случае в потоке будет храниться примерно 1000 последних записей, более старые Redis будет удалять по мере добавления новых. Это удобно для логов и аналитики, где не нужна бесконечная история.

## XREAD — чтение сообщений из потока

Команда **XREAD** читает сообщения из одного или нескольких потоков. Простейший пример — прочитать всё с начала:

```
XREAD COUNT 3 STREAMS orders:stream 0-0
```

Здесь:

- **COUNT 3** ограничивает количество возвращаемых сообщений;
- **STREAMS orders:stream** указывает, из какого потока читать;
- **0-0** означает «начать с самого начала потока».

Обычно **XREAD** используют для чтения только новых сообщений. Для этого вместо конкретного идентификатора передают доллар:

```
XREAD BLOCK 5000 STREAMS orders:stream $
```

Важные детали:

- **$** означает «ждать только новые сообщения, которых ещё нет у клиента»;
- **BLOCK 5000** говорит: подождать до 5 секунд появления новых данных, затем вернуть управление даже если сообщений нет.

Так клиент может держать соединение с Redis и получать события почти в реальном времени, не опрашивая сервер в цикле.

Если поток не существует, **XREAD** просто вернёт пустой результат. Ошибки не будет — это нужно учитывать в приложении и, при необходимости, создавать поток через **XADD** заранее.

## XGROUP — подготовка потока для групп потребителей

Группы потребителей — это ключевая возможность **Streams**, которая позволяет нескольким воркерам обрабатывать поток, не дублируя работу. Чтобы использовать группы, поток сначала нужно подготовить командой **XGROUP CREATE**.

Создадим поток задач на отправку писем и группу обработчиков:

```
XGROUP CREATE email:tasks:stream email-workers 0-0 MKSTREAM
```

Здесь:

- **email:tasks:stream** — ключ потока;
- **email-workers** — имя группы;
- **0-0** — с какого идентификатора считать сообщения доступными группе;
- **MKSTREAM** говорит Redis создать поток, если его ещё нет.

Чаще на практике используют специальное значение доллара:

```
XGROUP CREATE email:tasks:stream email-workers $ MKSTREAM
```

Так группа начнёт работу только с новыми сообщениями, которые появятся после создания, не затрагивая старую историю.

Если попытаться создать группу повторно с теми же именами потока и группы, Redis вернёт ошибку. Поэтому в автоматических скриптах часто используют вариант с игнорированием ошибки на создание или проверяют наличие группы заранее.

## Связка XADD, XREAD и XGROUP в живой системе

Реальная схема обычно выглядит так:

1. Один или несколько сервисов добавляют задачи в поток с помощью **XADD**.
2. Поток один раз подготавливается под группы с помощью **XGROUP CREATE**.
3. Воркеры читают сообщения уже не через **XREAD**, а через **XREADGROUP** (об этом подробно в следующем разделе).

Пример — постановка задач на отправку писем:

Создание группы:

```
XGROUP CREATE email:tasks:stream email-workers $ MKSTREAM
```

Добавление задач:

```
XADD email:tasks:stream * user_id 123 template "welcome"
XADD email:tasks:stream * user_id 456 template "reset_password"
```

Чтение новых задач без групп (для простого потребителя или отладки):

```
XREAD COUNT 10 STREAMS email:tasks:stream 0-0
```

В боевом варианте вместо этого используют чтение через **XREADGROUP**, чтобы распределять задачи между несколькими воркерами и подтверждать успешную обработку.

## Итог

Команды **XADD**, **XREAD** и **XGROUP** формируют базовый набор для работы с **Redis Streams**: первая пишет события, вторая читает их, третья готовит поток к распределённой обработке через группы потребителей.

Понимание этих команд позволяет уже на этом уровне построить простую, но рабочую систему очередей и логов. В следующем разделе мы углубимся в **Consumer Groups** и посмотрим, как организовать надёжную обработку сообщений несколькими воркерами с подтверждением и повторными попытками.