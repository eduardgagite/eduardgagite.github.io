---
title: "Шардинг"
category: "redis"
categoryTitle: "Redis"
section: "ha-cluster"
sectionTitle: "Высокая доступность и кластеризация"
sectionOrder: 8
order: 4
---

**Шардинг** в Redis — это разбиение ключей по нескольким узлам так, чтобы каждый узел хранил только часть данных. В режиме Redis Cluster шардинг встроен: кластер сам решает, на каком узле должен жить каждый ключ.

Задача разработчика — понимать, как работает распределение по слотам, и при необходимости управлять тем, какие ключи должны храниться вместе.

## Хэш‑слоты и распределение ключей

В Redis Cluster пространство ключей разбито на **16384 хэш‑слота**. Каждый ключ попадает в один слот по формуле:

```
hash_slot = CRC16(key) mod 16384
```

Каждый мастер в кластере отвечает за подмножество этих слотов. При изменении топологии (добавление/удаление узлов) слоты могут мигрировать между мастерами.

Посмотреть распределение слотов можно через:

```
CLUSTER SLOTS
```

Ответ покажет диапазоны слотов и узлы, за которые они отвечают.

## Управление группами ключей через hash tags

Иногда нужно, чтобы несколько ключей гарантированно оказались на одном и том же узле — например, для транзакций, Lua‑скриптов или операций с несколькими ключами. Для этого используют **hash tags**.

Идея простая: если в имени ключа есть фигурные скобки, для расчёта слота берётся только содержимое внутри скобок.

Пример:

```
SET user:{42}:profile "{...}"
SET user:{42}:settings "{...}"
```

Оба ключа попадут в один и тот же слот, потому что для хеша используется только подстрока **42**. Это позволяет безопасно использовать операции, которые требуют, чтобы все задействованные ключи были на одном мастере.

## Добавление и удаление шардов

Когда нагрузка растёт, в кластер можно добавить новые узлы и распределить слоты заново.

Пример добавления нового мастера:

```
redis-cli --cluster add-node 10.0.0.4:6379 10.0.0.1:6379
```

После этого слоты нужно перенести на новый узел:

```
redis-cli --cluster reshard 10.0.0.1:6379
```

Интерактивно выбирается, сколько слотов и откуда переносить. Кластер во время миграции использует редиректы **ASK**, но для клиентов, поддерживающих Redis Cluster, этот процесс прозрачен.

Удаление шардов работает похоже, только слоты сначала переносятся на другие мастера, а потом узел выбывает из кластера.

## Классический client-side шардинг

Помимо встроенного шардинга кластера, есть старый подход — **client-side шардинг**, когда приложение само решает, на какой Redis отправить ключ.

Пример идеи:

- есть три инстанса Redis;
- приложение считает хеш от ключа и по модулю количества инстансов выбирает нужный.

Такой подход проще на старте, но:

- не умеет автоматически перераспределять данные при изменении числа узлов;
- не даёт встроенного failover;
- требует много ручной работы при миграции.

Поэтому для новых проектов чаще выбирают Redis Cluster, а client-side шардинг оставляют для специфических случаев.

## Итог

Шардинг в **Redis Cluster** основан на 16384 хэш‑слотах, которые автоматически распределяются между мастер‑узлами и могут мигрировать при изменении топологии.

Используя hash tags и штатные команды кластера для добавления и удаления узлов, можно контролировать, какие ключи лежат вместе, и плавно масштабировать систему, не переписывая логику приложения.


