---
title: "Автоматическое переключение"
category: "redis"
categoryTitle: "Redis"
section: "ha-cluster"
sectionTitle: "Высокая доступность и кластеризация"
sectionOrder: 8
order: 2
---

Автоматическое переключение (failover) в связке Redis + Sentinel означает, что при падении master система сама выбирает новую реплику и делает её основным узлом. Задача приложения — уметь быстро узнать новый адрес и продолжить работу без ручного вмешательства.

Разберём, как выглядит процесс failover шаг за шагом и какие настройки влияют на его поведение.

## Как Sentinel принимает решение о failover

Sentinel периодически пингует master и реплики. Когда master не отвечает дольше заданного порога, начинается процедура выбора нового master.

Ключевые параметры:

```
sentinel down-after-milliseconds mymaster 5000
sentinel failover-timeout mymaster 60000
sentinel parallel-syncs mymaster 1
```

Смысл:

- **down-after-milliseconds** — сколько миллисекунд без ответа считать master недоступным;
- **failover-timeout** — общее окно для проведения failover;
- **parallel-syncs** — сколько реплик можно одновременно пересинхронизировать с новым master.

Решение о том, что master действительно мёртв (not reachable), принимается большинством Sentinel. Поэтому обычно поднимают минимум три экземпляра на разных серверах.

## Процесс автоматического переключения

Когда quorum Sentinel согласился, что master недоступен, начинается failover:

1. Из доступных реплик выбирается кандидат в новый master (учитываются задержка, отставание, приоритет).
2. Кандидату посылается команда стать самостоятельным master:

```
REPLICAOF NO ONE
```

3. Остальным репликам указывают новый master:

```
REPLICAOF <ip-нового-master> 6379
```

4. Информация о новом master публикуется через Sentinel, и клиенты, которые умеют с ним общаться, получают обновлённый адрес.

Весь этот процесс занимает от нескольких секунд до десятков секунд, в зависимости от настроек и качества сети.

## Как клиенты находят новый master

Клиенты, поддерживающие Sentinel, обычно:

1. Подключаются к набору Sentinel (например, по трём адресам).
2. Запрашивают у него координаты master по имени:

```
SENTINEL get-master-addr-by-name mymaster
```

3. Подключаются к полученному адресу и используют его для команд записи.
4. При ошибках подключения к Redis снова идут к Sentinel за обновлённым адресом.

Если драйвер Redis в вашем языке не умеет работать с Sentinel, это можно обернуть отдельным слоем (прокси, сервис‑дискавери), который сам следит за Sentinel и отдаёт клиентам актуальный endpoint.

## Типичные грабли при автоматическом переключении

На практике проблемы чаще всего связаны не с самим Sentinel, а с окружением:

- слишком маленький **down-after-milliseconds** — частые ложные срабатывания при временных задержках сети;
- клиенты закэшировали старый адрес master и не ходят к Sentinel за новым;
- DNS или балансировщик не обновляют конфигурацию после failover;
- реплики отстают слишком сильно, и новый master поднимается с устаревшими данными.

Поэтому важно:

- тестировать сценарии failover на тестовой среде;
- проверять, как реальные клиенты узнают о новом master;
- мониторить отставание реплик и время проведения failover.

## Итог

Автоматическое переключение с помощью **Redis Sentinel** позволяет переживать падение master без ручного вмешательства: система сама выбирает реплику, продвигает её в master и перенастраивает остальные узлы.

Если клиенты правильно интегрированы с Sentinel и настройки порогов подобраны под реальную сеть, Redis становится заметно устойчивее к сбоям отдельных серверов и кратковременным проблемам с инфраструктурой.


