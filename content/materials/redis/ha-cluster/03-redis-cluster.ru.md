---
title: "Redis Cluster"
category: "redis"
categoryTitle: "Redis"
section: "ha-cluster"
sectionTitle: "Высокая доступность и кластеризация"
sectionOrder: 8
order: 3
---

**Redis Cluster** — это режим работы, в котором данные автоматически распределяются по нескольким узлам (шартам), а внутри каждого шарда всё ещё может быть master и реплики. Задача кластера — одновременно дать масштабирование по объёму данных и по нагрузке, сохраняя при этом отказоустойчивость.

В отличие от схемы «один master + несколько реплик», Redis Cluster умеет сам решать, на какой узел положить ключ, и как перенаправить клиента, если он обратился не туда.

## Базовая идея кластера

В кластере Redis есть:

- несколько master‑узлов, каждый хранит свою часть ключей;
- опционально — реплики у каждого master для высокой доступности;
- специальный механизм распределения ключей по **16384 слотам**.

Каждый ключ попадает в один из 16384 хэш‑слотов по хешу:

```
hash_slot = CRC16(key) mod 16384
```

Каждый слот закреплён за конкретным master. Если мастер уходит из строя, и у него есть реплика, кластер может автоматически переключить слот на реплику.

## Минимальная конфигурация кластера

Для запуска кластера нужно несколько инстансов Redis с включённым режимом cluster.

Часть настроек в redis.conf:

```
port 6379
cluster-enabled yes
cluster-config-file nodes.conf
cluster-node-timeout 5000
```

После запуска нескольких таких инстансов их объединяют в кластер с помощью утилиты:

```
redis-cli --cluster create \
  10.0.0.1:6379 10.0.0.2:6379 10.0.0.3:6379 \
  --cluster-replicas 1
```

Флаг **--cluster-replicas 1** говорит, что для каждого master будет создана одна реплика. В итоге получится набор мастер‑реплика пар, между которыми распределены все 16384 слота.

## Маршрутизация запросов и редиректы

Клиент кластера может попасть не на тот мастер, который хранит нужный ключ. В этом случае Redis отвечает редиректом:

- **MOVED** — ключ живёт на другом узле, и этот слот уже закреплён за ним;
- **ASK** — временный редирект во время переноса слотов между узлами.

Пример:

```
SET user:42 "Alice"
```

Если запрос пришёл не на тот узел, клиент получит ответ вида:

```
MOVED 12539 10.0.0.2:6379
```

Дальше драйвер Redis, умеющий работать с кластером, сам перенаправит запрос на правильный узел и обновит у себя карту слотов.

## Когда Redis Cluster уместен

Кластер имеет смысл, когда:

- данных становится слишком много для одного сервера (по памяти или по диску);
- нагрузка на один инстанс Redis превышает комфортный предел;
- нужно горизонтально масштабировать чтение и запись по нескольким узлам.

Важно помнить:

- в режиме кластера не все команды доступны в прежнем виде (особенно мульти‑ключевые);
- транзакции и Lua‑скрипты должны работать с ключами из одного слота;
- есть свои особенности при миграции данных и смене топологии.

Для сценариев, где достаточно одного узла с репликами, кластер может быть излишне сложным. Но для крупных систем с ростом данных это стандартный путь масштабирования Redis.

## Итог

**Redis Cluster** распределяет ключи по нескольким master‑узлам, добавляя к репликации автоматический шардинг и встроенный механизм отказоустойчивости.

Если драйверы клиентов умеют работать с кластером, а ограничения по командам приняты в расчёт, кластер позволяет плавно наращивать объём данных и обрабатывать всё более высокую нагрузку без единой точки отказа.


