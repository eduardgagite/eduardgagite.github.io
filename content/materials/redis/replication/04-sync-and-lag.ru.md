---
title: "Синхронизация и задержки"
category: "redis"
categoryTitle: "Redis"
section: "replication"
sectionTitle: "Репликация"
sectionOrder: 7
order: 4
---

Репликация в Redis асинхронная: master не ждёт, пока все реплики применят изменения, прежде чем ответить клиенту. Это делает систему очень быстрой, но всегда оставляет небольшой риск отставания и потери части последних данных при сбое.

Чтобы управлять этим риском, важно понимать, как работает синхронизация, как измерять задержки и в каких ситуациях имеет смысл ждать подтверждения от реплик.

## Полная и частичная синхронизация

При первом подключении replica делает полную синхронизацию:

1. master создаёт snapshot и отправляет его реплике;
2. replica загружает snapshot и применяет его;
3. после этого replica продолжает принимать поток новых команд.

Если соединение временно обрывается, Redis пытается использовать частичную синхронизацию. Для этого он:

- ведёт журнал смещений репликации (offset);
- хранит недавние команды в буфере.

Если отставание реплики укладывается в этот буфер, мастер досылает только недостающие команды. Если нет — запускается новая полная синхронизация.

Понять, что происходит, можно через:

```
INFO replication
```

Там видно смещения, состояние связей и отставание по каждой реплике.

## Измерение задержек между master и replica

В разделе репликации **INFO** показывает показатель **lag** для каждой реплики:

```
slave0:ip=10.0.0.2,port=6379,state=online,offset=12345,lag=1
```

Полезные значения:

- **lag** — сколько секунд прошло с момента последнего подтверждения от replica;
- **offset** — позиция в потоке репликации.

Если **lag** растёт и долго держится на больших значениях, это сигнал, что:

- сеть между master и replica нестабильна;
- ресурсы на реплике не успевают переваривать поток команд;
- или есть проблемы с диском, если включены тяжёлые режимы персистентности.

Такие ситуации стоит мониторить и настраивать алерты.

## Когда надо ждать подтверждения от реплик (WAIT)

Для операций, которые нельзя потерять, Redis предлагает команду **WAIT**. Она позволяет дождаться, пока данные будут гарантированно записаны на заданное число реплик.

Пример:

```
SET order:501 "..."
WAIT 1 1000
```

Здесь:

- первое число — сколько реплик нужно дождаться;
- второе — таймаут в миллисекундах.

Redis вернёт число реплик, которые подтвердили запись за отведённое время. Если это число меньше ожидаемого, приложение может принять решение:

- повторить операцию позже;
- зафиксировать факт частичной репликации;
- временно остановить критичные операции.

Важно помнить, что **WAIT** увеличивает задержку ответа для клиента и не превращает Redis в полностью синхронную систему, но даёт больше контроля для отдельных особо важных операций.

## Практические рекомендации по работе с задержками

Несколько рабочих правил:

- не считать, что replica всегда идеально синхронизирована с master — небольшое отставание нормально;
- мониторить **lag** и **offset** через **INFO replication**;
- аккуратно относиться к чтению с реплик там, где нужны строго консистентные данные;
- использовать **WAIT** только для критичных операций, где допустима дополнительная задержка;
- следить, чтобы полная синхронизация не запускалась слишком часто — это признак проблем с сетью, памятью или конфигурацией.

## Итог

Синхронизация и задержки в репликации **Redis** — это баланс между скоростью и консистентностью: асинхронная модель делает систему очень быстрой, но требует осознанного отношения к отставанию реплик.

Если регулярно смотреть на метрики репликации и точечно использовать инструменты вроде **WAIT**, можно контролировать риск потери данных и при этом не потерять главное преимущество Redis — высокую производительность.


