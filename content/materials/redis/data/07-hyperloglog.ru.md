---
title: "Работа с HyperLogLog"
category: "redis"
categoryTitle: "Redis"
section: "data"
sectionTitle: "Структуры данных"
sectionOrder: 2
order: 7
---

**HyperLogLog** — это структура данных для приблизительного подсчёта количества уникальных элементов. Она не хранит сами элементы, а только оценивает, сколько их было. За счёт этого **HyperLogLog** занимает очень мало памяти — всего около 12 килобайт на структуру — и может обрабатывать миллиарды уникальных значений.

Точность оценки обычно составляет около 0.81% стандартной ошибки, что для большинства аналитических задач вполне достаточно. Если нужен точный подсчёт уникальных элементов, лучше использовать обычные множества, но они занимают намного больше памяти.

## Добавление элементов

Команда **PFADD** добавляет один или несколько элементов в структуру.

Пример подсчёта уникальных посетителей сайта:

```
PFADD visitors:2025-11-21 user_42
PFADD visitors:2025-11-21 user_100
PFADD visitors:2025-11-21 user_42
```

Здесь:

- **visitors:2025-11-21** — ключ для хранения структуры за конкретный день;
- **user_42**, **user_100** — идентификаторы посетителей.

Если один и тот же элемент добавляется несколько раз (как **user_42** в примере), структура учитывает его только один раз.

Можно добавить несколько элементов за один вызов:

```
PFADD visitors:2025-11-21 user_42 user_100 user_789
```

## Получение оценки количества уникальных элементов

Команда **PFCOUNT** возвращает приблизительное количество уникальных элементов.

Пример:

```
PFCOUNT visitors:2025-11-21
```

Команда вернёт число, например **1523**, которое означает, что примерно столько уникальных посетителей было за день.

Важно понимать, что это оценка, а не точное значение. Для большинства аналитических задач такая точность достаточна, особенно когда речь идёт о миллионах или миллиардах элементов.

## Объединение нескольких HyperLogLog

Команда **PFMERGE** объединяет несколько структур в одну. Это полезно, когда нужно посчитать уникальные элементы за период: например, за неделю или месяц.

Пример объединения данных за несколько дней:

```
PFADD visitors:2025-11-21 user_42 user_100
PFADD visitors:2025-11-22 user_42 user_200
PFADD visitors:2025-11-23 user_100 user_200

PFMERGE visitors:week visitors:2025-11-21 visitors:2025-11-22 visitors:2025-11-23
PFCOUNT visitors:week
```

Результат покажет приблизительное количество уникальных посетителей за всю неделю, учитывая, что один и тот же пользователь мог заходить в разные дни.

## Практические сценарии

**Подсчёт уникальных посетителей.** Каждый визит добавляется в структуру, **PFCOUNT** показывает оценку уникальных пользователей за день, неделю, месяц.

```
PFADD visitors:2025-11-21 "192.168.1.1"
PFADD visitors:2025-11-21 "192.168.1.2"
PFCOUNT visitors:2025-11-21
```

**Аналитика поисковых запросов.** Сколько уникальных поисковых запросов было за период.

```
PFADD searches:2025-11-21 "redis tutorial"
PFADD searches:2025-11-21 "redis caching"
PFCOUNT searches:2025-11-21
```

**Отслеживание уникальных событий.** Сколько уникальных пользователей выполнили действие (кликнули, подписались, купили).

```
PFADD clicks:button:buy:2025-11-21 user_42
PFADD clicks:button:buy:2025-11-21 user_100
PFCOUNT clicks:button:buy:2025-11-21
```

**Агрегация по регионам или категориям.** Уникальные посетители по странам, уникальные товары по категориям.

```
PFADD visitors:country:US:2025-11-21 user_1
PFADD visitors:country:US:2025-11-21 user_2
PFADD visitors:country:RU:2025-11-21 user_3
PFCOUNT visitors:country:US:2025-11-21
```

## Сравнение с обычными множествами

Для точного подсчёта уникальных элементов можно использовать обычные множества:

```
SADD visitors:exact:2025-11-21 user_42
SADD visitors:exact:2025-11-21 user_100
SCARD visitors:exact:2025-11-21
```

Но есть важные различия:

- **Память:** множество хранит все элементы и занимает память пропорционально количеству элементов. **HyperLogLog** всегда занимает около 12 КБ.
- **Точность:** множество даёт точный результат, **HyperLogLog** — приблизительный (ошибка около 0.81%).
- **Скорость:** оба варианта быстрые, но **HyperLogLog** обычно быстрее при больших объёмах данных.

Выбор зависит от задачи: если нужна точность и элементов немного (тысячи, десятки тысяч), лучше множества. Если элементов миллионы или миллиарды, а небольшая погрешность допустима, **HyperLogLog** сэкономит много памяти.

## Ограничения и особенности

**HyperLogLog** не позволяет:

- получить список элементов (структура их не хранит);
- проверить, был ли конкретный элемент добавлен;
- удалить отдельный элемент.

Если нужны такие операции, лучше использовать обычные множества или другие структуры.

Важно помнить:

- оценка может отличаться от реального значения на 0.81% в среднем;
- структура занимает фиксированный объём памяти (около 12 КБ), независимо от количества элементов;
- при объединении нескольких структур точность сохраняется.

## Итого

**HyperLogLog в Redis** даёт компактный способ приблизительно подсчитывать уникальные элементы в огромных потоках данных, занимая при этом минимум памяти.

Для аналитических задач, где важна оценка количества уникальных значений (посетители, события, запросы), а не точный список элементов, **PFADD** и **PFCOUNT** предоставляют эффективное решение с минимальным расходом ресурсов.

