---
title: "Работа с Bitmaps"
category: "redis"
categoryTitle: "Redis"
section: "data"
sectionTitle: "Структуры данных"
sectionOrder: 2
order: 6
---

**Bitmaps** в Redis — это способ хранить и обрабатывать данные на уровне отдельных битов. Внутри это обычные строки, но команды **BIT*** позволяют работать с ними как с массивами битов. Это даёт очень компактное хранение для задач, где нужно отмечать наличие или отсутствие чего‑то: активность пользователя по дням, флаги, бинарные состояния.

Главное преимущество — экономия памяти: один бит вместо целого числа или строки. Для больших массивов данных это может дать существенную экономию.

## Установка и чтение битов

Команда **SETBIT** устанавливает бит в позицию 0 или 1, а **GETBIT** читает значение бита.

Пример отметки активности пользователя по дням:

```
SETBIT user:42:activity 0 1
SETBIT user:42:activity 1 1
SETBIT user:42:activity 2 0
SETBIT user:42:activity 3 1
```

Здесь:

- **user:42:activity** — ключ для хранения битов;
- первое число — позиция бита (например, день недели или день месяца);
- последнее число — значение: **1** (активен) или **0** (неактивен).

Проверка активности в конкретный день:

```
GETBIT user:42:activity 3
```

Команда вернёт **1**, если пользователь был активен, и **0**, если нет.

## Подсчёт установленных битов

Команда **BITCOUNT** считает, сколько битов установлено в 1.

Пример:

```
BITCOUNT user:42:activity
```

Это полезно для быстрого подсчёта: сколько дней пользователь был активен, сколько флагов установлено, сколько событий произошло.

Можно считать биты в определённом диапазоне:

```
BITCOUNT user:42:activity 0 6
```

Здесь считаются биты с позиции 0 по 6 (например, активность за неделю).

## Битовая операция AND

Команда **BITOP AND** выполняет побитовое И между несколькими bitmap и сохраняет результат в новый ключ.

Пример поиска пользователей, активных в оба дня:

```
SETBIT user:42:activity 0 1
SETBIT user:42:activity 1 1
SETBIT user:100:activity 0 1
SETBIT user:100:activity 1 0

BITOP AND result user:42:activity user:100:activity
GETBIT result 0
```

Результат будет содержать **1** только в тех позициях, где оба исходных bitmap имели **1**.

Это удобно для поиска пересечений: какие пользователи были активны и в понедельник, и во вторник.

## Битовая операция OR

Команда **BITOP OR** выполняет побитовое ИЛИ — результат содержит **1**, если хотя бы в одном из bitmap бит установлен.

Пример:

```
BITOP OR result user:42:activity user:100:activity
```

Это полезно для объединения данных: активность хотя бы одного из пользователей, события из разных источников.

## Битовая операция XOR

Команда **BITOP XOR** возвращает **1** только там, где биты различаются между bitmap.

Пример:

```
BITOP XOR result user:42:activity user:100:activity
```

Это можно использовать для поиска различий: какие дни отличаются между двумя пользователями.

## Битовая операция NOT

Команда **BITOP NOT** инвертирует все биты в bitmap.

Пример:

```
BITOP NOT inverted user:42:activity
```

Теперь **inverted** содержит обращённые значения: где было **1**, стало **0**, и наоборот.

## Поиск первого установленного бита

Команда **BITPOS** находит позицию первого бита с заданным значением.

Пример поиска первого дня активности:

```
BITPOS user:42:activity 1
```

Команда вернёт номер позиции первого установленного бита. Если нужно найти первый **0**, указывают:

```
BITPOS user:42:activity 0
```

Можно искать в определённом диапазоне:

```
BITPOS user:42:activity 1 0 6
```

## Практические сценарии

**Отслеживание активности по дням.** Каждый день месяца — один бит. Если пользователь был активен, бит устанавливается в **1**.

```
SETBIT user:42:activity:2025-11 20 1
BITCOUNT user:42:activity:2025-11
```

**Флаги и настройки.** Разные биты хранят разные флаги: уведомления включены, подписка активна, верификация пройдена.

```
SETBIT user:42:flags 0 1
SETBIT user:42:flags 1 0
SETBIT user:42:flags 2 1
```

**Аналитика пересечений.** Какие пользователи были активны и в понедельник, и во вторник, и в среду.

```
BITOP AND weekdays monday tuesday wednesday
BITCOUNT weekdays
```

**Отслеживание уникальных событий.** Каждое событие — один бит. Если событие произошло, бит устанавливается. **BITCOUNT** показывает, сколько уникальных событий было.

## Ограничения и особенности

Bitmaps эффективны, когда данных много, а значения бинарные (есть/нет). Если нужно хранить сложные структуры или частые обновления затрагивают большие диапазоны, лучше использовать другие структуры.

Важно помнить:

- позиции битов должны быть неотрицательными целыми числами;
- для очень больших позиций (миллионы) память всё равно будет заниматься, даже если установлено мало битов;
- операции **BITOP** создают новый ключ, что требует дополнительной памяти.

## Итого

**Bitmaps в Redis** дают компактный способ хранить бинарные данные и выполнять быстрые операции над ними: подсчёт установленных битов, поиск пересечений, объединение данных.

Для задач вроде отслеживания активности, хранения флагов и анализа больших массивов бинарных данных **BIT*** команды предоставляют эффективный инструмент с минимальным расходом памяти.

