---
title: "Диагностика памяти и горячих ключей"
category: "redis"
categoryTitle: "Redis"
section: "monitoring"
sectionTitle: "Мониторинг и отладка"
sectionOrder: 10
order: 4
---

Когда Redis начинает упираться в лимит памяти или отдельные ключи вызывают всплески нагрузки, важно уметь быстро понять, кто именно виноват. Для этого пригодятся команды **MEMORY** и инструменты вроде **LATENCY DOCTOR**, а также аккуратный обход ключей.

Часть этих приёмов уже встречалась в разделе про управление памятью, здесь посмотрим на них с точки зрения мониторинга и быстрой диагностики.

## Быстрая оценка памяти через INFO и MEMORY STATS

Первый шаг — посмотреть общую картину:

```
INFO memory
```

Если used_memory близок к maxmemory или mem_fragmentation_ratio заметно больше 1, стоит копнуть глубже.

Более детальный снимок:

```
MEMORY STATS
```

Команда возвращает массив статистик: сколько памяти уходит на данные, на служебные структуры, на аллокатор. Эти данные удобно загонять в мониторинг, чтобы отслеживать тренды роста и понимать, где именно «толстеет» Redis.

## Поиск тяжёлых ключей через MEMORY USAGE

Чтобы найти, какие ключи занимают больше всего памяти, можно пройтись по ним через SCAN и для каждого замерить размер.

Пример ручного подхода:

```
SCAN 0 MATCH cache:* COUNT 100
MEMORY USAGE cache:article:1
MEMORY USAGE cache:article:2
```

На практике:

- скрипт на стороне приложения обходит ключи по SCAN;
- вызывает **MEMORY USAGE** для каждого;
- строит топ‑N самых тяжёлых ключей.

Так легко обнаружить:

- слишком крупные JSON‑значения;
- ключи без TTL, которые накопили огромные структуры;
- неожиданные коллекции логов и очередей.

## Поиск горячих ключей через мониторинг

Горячие ключи — это те, к которым идёт непропорционально много обращений. Они могут становиться узким местом: один ключ с тяжёлым значением, который читают тысячи раз в секунду.

Простейший приём:

- временно включить **MONITOR** на тестовой реплике или в ограниченное время;
- отфильтровать поток команд по ключам и посчитать частоту обращений.

Пример:

```
MONITOR
```

Дальше парсер или отдельный инструмент считает, какие ключи встречаются чаще всего. Такие ключи:

- кандидаты на оптимизацию структуры данных;
- могут требовать кэширования на стороне приложения;
- иногда подсказка, что данные стоит разнести по нескольким ключам.

## LATENCY DOCTOR и неожиданные задержки

Redis имеет встроенный инструмент для анализа задержек:

```
LATENCY DOCTOR
```

Он пытается автоматически найти и описать проблемы:

- длительные блокирующие операции;
- резкие скачки в работе диска;
- аномалии в репликации.

Вывод команды даёт текстовые рекомендации и может указать, где искать корень проблемы — в памяти, диске, сети или конкретных командах.

## Итог

Диагностика памяти и горячих ключей в **Redis** опирается на INFO и MEMORY STATS для общей картины, MEMORY USAGE и SCAN для поиска тяжёлых ключей, а также MONITOR и LATENCY DOCTOR для анализа частоты обращений и задержек.

Если держать под рукой эти инструменты и периодически смотреть на них не только во время аварий, многие проблемы с памятью и узкими местами можно поймать и исправить заранее.


