---
title: "Логирование и наблюдаемость"
category: "golang"
categoryTitle: "Go"
section: "best-practices"
sectionTitle: "Практики и качество"
sectionOrder: 11
order: 2
---

Когда приложение работает в продакшене, вы не можете подключиться к нему отладчиком и поставить breakpoint. Единственный способ понять, что происходит — **логи**.

Хорошие логи экономят часы при поиске багов. Плохие — создают шум и не помогают.

## Стандартный пакет log

Go поставляется с пакетом `log`. Он простой, но ограниченный.

```go
import "log"

func main() {
    log.Println("Сервер запущен")
    log.Printf("Порт: %d", 8080)
    
    // Fatal = Print + os.Exit(1)
    log.Fatal("Критическая ошибка, выключаюсь")
}
```

Вывод:
```
2025/01/28 14:30:00 Сервер запущен
2025/01/28 14:30:00 Порт: 8080
```

## Структурированное логирование (slog)

Начиная с Go 1.21, в стандартной библиотеке появился пакет `log/slog` — современный логгер со структурированным выводом.

### Почему структурированные логи лучше?

Обычный лог:
```
2025-01-28 14:30:00 Ошибка при получении пользователя: connection refused
```

Структурированный лог (JSON):
```json
{"time":"2025-01-28T14:30:00Z","level":"ERROR","msg":"Ошибка при получении пользователя","user_id":42,"error":"connection refused"}
```

Второй вариант легко парсить, фильтровать и искать в системах мониторинга (Grafana, Kibana, Datadog).

### Использование slog

```go
import "log/slog"

func main() {
    // Текстовый формат (для разработки)
    slog.Info("Сервер запущен", "port", 8080)
    // 2025/01/28 14:30:00 INFO Сервер запущен port=8080

    // Предупреждение
    slog.Warn("Медленный запрос", "duration_ms", 1500, "path", "/api/users")

    // Ошибка
    slog.Error("Не удалось подключиться к БД", "error", err, "host", "db.example.com")
}
```

### JSON-формат (для продакшена)

```go
logger := slog.New(slog.NewJSONHandler(os.Stdout, nil))
slog.SetDefault(logger)

slog.Info("Запрос обработан", "method", "GET", "path", "/users", "status", 200)
// {"time":"...","level":"INFO","msg":"Запрос обработан","method":"GET","path":"/users","status":200}
```

## Уровни логирования

Используйте правильные уровни:

- **Debug**: Детали для разработки. Не включайте в продакшене.
- **Info**: Важные события: "Сервер запущен", "Миграции применены".
- **Warn**: Что-то подозрительное, но работа продолжается: "Медленный запрос".
- **Error**: Что-то сломалось: "Не удалось подключиться к БД".

### Фильтрация по уровню

```go
// В продакшене показываем только Warn и Error
opts := &slog.HandlerOptions{Level: slog.LevelWarn}
logger := slog.New(slog.NewJSONHandler(os.Stdout, opts))
```

## Что логировать

**Логируйте**:
- Старт и остановку сервера.
- Входящие запросы (метод, путь, время выполнения, статус).
- Ошибки с контекстом (ID пользователя, параметры запроса).
- Подключение/отключение от внешних сервисов.

**Не логируйте**:
- Пароли, токены, персональные данные.
- Каждую итерацию цикла (забьете диск за минуты).
- Успешные проверки (логируйте только отклонения).

## Итог

1. Используйте `log/slog` для структурированного логирования.
2. В разработке — текстовый формат. В продакшене — JSON.
3. Добавляйте контекст к логам: `"user_id", 42, "method", "GET"`.
4. Никогда не логируйте секреты (пароли, токены, ключи API).
