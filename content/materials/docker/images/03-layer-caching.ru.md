---
title: "Кеш слоёв и оптимизация порядка команд"
category: "docker"
categoryTitle: "Docker"
section: "images"
sectionTitle: "Dockerfile и сборка образов"
sectionOrder: 4
order: 3
---

Сборка Docker-образа работает послойно. Каждая инструкция в Dockerfile (**RUN**, **COPY**) создает новый слой.
Docker очень умен: он **кеширует** каждый слой. Если вы ничего не меняли в инструкции и файлах, которые она трогает, Docker мгновенно возьмет готовый слой из кеша, вместо того чтобы выполнять команду заново.

Это критически важно для скорости сборки (CI/CD).

## Правильный порядок: от редкого к частому

Посмотрите на этот "плохой" Dockerfile, где весь код копируется одной командой до установки зависимостей:

```
FROM node:18
WORKDIR /app
COPY . .
RUN npm install
CMD ["node", "index.js"]
```

Почему это плохо?
Если вы измените хоть одну запятую в коде (**index.js**), инструкция **COPY . .** изменится (так как изменилась чексумма файлов).
Значит, Docker сбросит кеш для этого слоя и **всех последующих**.
Следовательно, **RUN npm install** будет выполняться заново при каждом изменении кода!

## Оптимизированный вариант

Мы разделяем копирование зависимостей и кода. Сначала копируем только файлы описания зависимостей и устанавливаем их — этот слой закешируется и не будет пересобираться, пока не изменится **package.json**. И только потом копируем исходный код:

```
FROM node:18
WORKDIR /app
COPY package.json package-lock.json ./
RUN npm install
COPY . .
CMD ["node", "index.js"]
```

**Результат:**
Вы меняете код приложения 100 раз в день. Docker использует кеш для **npm install** (тяжелая операция) и просто быстро перекопирует легкие исходники. Сборка занимает 1 секунду вместо 2 минут.

## Правило

Располагайте инструкции в порядке **от наименее часто изменяемых к наиболее часто изменяемым**.

1. Установка системных пакетов (**apt install**).
2. Установка зависимостей проекта (**npm install**, **pip install**).
3. Копирование исходного кода.
4. Команда запуска.

## Итого

Используйте механизм слоев себе на пользу. Правильный порядок команд в Dockerfile может ускорить сборку в десятки раз.
