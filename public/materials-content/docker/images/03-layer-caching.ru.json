{"content":"\nСборка Docker-образа работает послойно. Каждая инструкция в Dockerfile (`RUN`, `COPY`) создает новый слой.\nDocker очень умен: он **кеширует** каждый слой. Если вы ничего не меняли в инструкции и файлах, которые она трогает, Docker мгновенно возьмет готовый слой из кеша, вместо того чтобы выполнять команду заново.\n\nЭто критически важно для скорости сборки (CI/CD).\n\n## Правильный порядок: от редкого к частому\n\nПосмотрите на этот \"плохой\" Dockerfile:\n\n```dockerfile\nFROM node:18\nWORKDIR /app\n\n# ПЛОХО: Мы копируем ВЕСЬ код сразу\nCOPY . .\n\n# А потом ставим зависимости\nRUN npm install\n\nCMD [\"node\", \"index.js\"]\n```\n\nПочему это плохо?\nЕсли вы измените хоть одну запятую в коде (`index.js`), инструкция `COPY . .` изменится (так как изменилась чексумма файлов).\nЗначит, Docker сбросит кеш для этого слоя и **всех последующих**.\nСледовательно, `RUN npm install` будет выполняться заново при каждом изменении кода!\n\n## Оптимизированный вариант\n\nМы разделяем копирование зависимостей и кода:\n\n```dockerfile\nFROM node:18\nWORKDIR /app\n\n# 1. Сначала копируем ТОЛЬКО файлы описания зависимостей\nCOPY package.json package-lock.json ./\n\n# 2. Ставим зависимости\n# Этот слой закешируется и не будет пересобираться, \n# пока вы не добавите новую библиотеку в package.json\nRUN npm install\n\n# 3. И только потом копируем исходный код\nCOPY . .\n\nCMD [\"node\", \"index.js\"]\n```\n\n**Результат:**\nВы меняете код приложения 100 раз в день. Docker использует кеш для `npm install` (тяжелая операция) и просто быстро перекопирует легкие исходники. Сборка занимает 1 секунду вместо 2 минут.\n\n## Правило\n\nРасполагайте инструкции в порядке **от наименее часто изменяемых к наиболее часто изменяемым**.\n\n1. Установка системных пакетов (`apt install`).\n2. Установка зависимостей проекта (`npm install`, `pip install`).\n3. Копирование исходного кода.\n4. Команда запуска.\n\n## Итого\n\nИспользуйте механизм слоев себе на пользу. Правильный порядок команд в Dockerfile может ускорить сборку в десятки раз.\n\n"}