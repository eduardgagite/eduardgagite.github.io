{"content":"\n**Cobra** — стандартный фреймворк для построения CLI в Go. На нём написаны **kubectl**, **Hugo**, **GitHub CLI** и сотни других инструментов. Cobra даёт подкоманды, автодополнение, встроенную документацию и многое другое.\n\n## Установка\n\n```\ngo get github.com/spf13/cobra@latest\n```\n\nОпционально — генератор для быстрого старта:\n\n```\ngo install github.com/spf13/cobra-cli@latest\ncobra-cli init myapp\ncobra-cli add server\n```\n\n## Структура Cobra-приложения\n\nCobra строится вокруг двух типов:\n- **cobra.Command** — команда или подкоманда.\n- **cobra.Command.Flags()** — флаги для команды.\n\nТипичная структура проекта:\n\n```\nmyapp/\n├── cmd/\n│   ├── root.go       — корневая команда\n│   ├── server.go     — подкоманда server\n│   └── migrate.go    — подкоманда migrate\n└── main.go\n```\n\n## main.go — точка входа\n\n```\npackage main\n\nimport \"myapp/cmd\"\n\nfunc main() {\n    cmd.Execute()\n}\n```\n\n## cmd/root.go — корневая команда\n\n```\npackage cmd\n\nimport (\n    \"os\"\n    \"github.com/spf13/cobra\"\n)\n\nvar rootCmd = &cobra.Command{\n    Use:   \"myapp\",\n    Short: \"Мой CLI-инструмент\",\n    Long:  `Подробное описание инструмента. Показывается при myapp --help.`,\n}\n\nfunc Execute() {\n    if err := rootCmd.Execute(); err != nil {\n        os.Exit(1)\n    }\n}\n```\n\n## cmd/server.go — подкоманда с флагами\n\n```\npackage cmd\n\nimport (\n    \"fmt\"\n    \"github.com/spf13/cobra\"\n)\n\nvar (\n    serverPort int\n    serverHost string\n)\n\nvar serverCmd = &cobra.Command{\n    Use:   \"server\",\n    Short: \"Запустить HTTP-сервер\",\n    Long:  `Запускает HTTP-сервер на указанном хосте и порту.`,\n    RunE: func(cmd *cobra.Command, args []string) error {\n        fmt.Printf(\"Запуск сервера на %s:%d\\n\", serverHost, serverPort)\n        return startServer(serverHost, serverPort)\n    },\n}\n\nfunc init() {\n    rootCmd.AddCommand(serverCmd)\n\n    serverCmd.Flags().IntVarP(&serverPort, \"port\", \"p\", 8080, \"порт сервера\")\n    serverCmd.Flags().StringVarP(&serverHost, \"host\", \"H\", \"0.0.0.0\", \"хост сервера\")\n    serverCmd.MarkFlagRequired(\"port\") // Обязательный флаг\n}\n```\n\n**RunE** возвращает ошибку — Cobra автоматически напечатает её и выйдет с кодом 1.\n\n## Флаги: локальные и постоянные\n\n```\n// Локальный флаг — только для этой команды\ncmd.Flags().StringVarP(&output, \"output\", \"o\", \"\", \"файл вывода\")\n\n// Постоянный флаг — для команды и всех её подкоманд\ncmd.PersistentFlags().BoolVarP(&verbose, \"verbose\", \"v\", false, \"подробный вывод\")\n```\n\nПостоянные флаги удобны для опций вроде **--config**, **--verbose**, **--output** которые нужны везде.\n\n## Глобальные флаги в root\n\n```\nvar cfgFile string\nvar verbose bool\n\nfunc init() {\n    rootCmd.PersistentFlags().StringVar(&cfgFile, \"config\", \"\", \"файл конфигурации\")\n    rootCmd.PersistentFlags().BoolVarP(&verbose, \"verbose\", \"v\", false, \"подробный вывод\")\n}\n```\n\n## PreRun и PostRun\n\nCobra поддерживает хуки до и после выполнения команды:\n\n```\nvar serverCmd = &cobra.Command{\n    Use: \"server\",\n    PersistentPreRunE: func(cmd *cobra.Command, args []string) error {\n        return initLogger(verbose)\n    },\n    RunE: func(cmd *cobra.Command, args []string) error {\n        return startServer()\n    },\n    PostRunE: func(cmd *cobra.Command, args []string) error {\n        return cleanup()\n    },\n}\n```\n\n**PersistentPreRunE** выполняется перед командой и всеми её подкомандами — удобно для инициализации.\n\n## Позиционные аргументы\n\n```\nvar getCmd = &cobra.Command{\n    Use:   \"get <resource> <name>\",\n    Short: \"Получить ресурс\",\n    Args:  cobra.ExactArgs(2), // Требуем ровно 2 аргумента\n    RunE: func(cmd *cobra.Command, args []string) error {\n        resource := args[0]\n        name := args[1]\n        fmt.Printf(\"Получаем %s/%s\\n\", resource, name)\n        return nil\n    },\n}\n```\n\nВстроенные валидаторы аргументов:\n- **cobra.ExactArgs(n)** — ровно n аргументов\n- **cobra.MinimumNArgs(n)** — минимум n аргументов\n- **cobra.MaximumNArgs(n)** — максимум n аргументов\n- **cobra.RangeArgs(min, max)** — от min до max\n- **cobra.NoArgs** — аргументов не должно быть\n\n## Автодополнение\n\nCobra автоматически генерирует скрипты автодополнения для bash, zsh, fish и PowerShell:\n\n```\n./myapp completion bash > /etc/bash_completion.d/myapp\n./myapp completion zsh > ~/.zsh/completions/_myapp\n```\n\nДля кастомного автодополнения значений флагов:\n\n```\nserverCmd.RegisterFlagCompletionFunc(\"host\", func(cmd *cobra.Command, args []string, toComplete string) ([]string, cobra.ShellCompDirective) {\n    return []string{\"localhost\", \"0.0.0.0\", \"127.0.0.1\"}, cobra.ShellCompDirectiveNoFileComp\n})\n```\n\n## Итого\n\nCobra — стандарт де-факто для CLI в Go. Основная структура: **корневая команда** в **root.go**, **подкоманды** в отдельных файлах в **cmd/**, регистрация через **init()**. Используйте **RunE** вместо **Run** — возврат ошибки чище, чем **os.Exit(1)**. **PersistentPreRunE** удобен для общей инициализации (логгер, конфиг, трассировка).\n"}