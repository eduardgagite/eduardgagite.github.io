{"content":"\nКод приложения хранится в Git. Любое изменение можно посмотреть, откатить, перенести на другой сервер. А что насчет структуры базы данных?\n\nЕсли один разработчик добавил колонку в таблицу, а другой об этом не знает — приложение сломается. **Миграции** решают эту проблему: структура БД тоже хранится в коде и применяется автоматически.\n\n## Что такое миграция\n\nМиграция — это файл с SQL-командами, которые изменяют структуру базы. Каждая миграция имеет:\n1. **Порядковый номер** (или timestamp) — чтобы применять в правильном порядке.\n2. **Up** — что делать при применении (добавить таблицу, колонку).\n3. **Down** — что делать при откате (удалить таблицу, колонку).\n\n```\nmigrations/\n├── 001_create_users.up.sql\n├── 001_create_users.down.sql\n├── 002_add_email_to_users.up.sql\n└── 002_add_email_to_users.down.sql\n```\n\n### Пример файлов\n\n```sql\n-- 001_create_users.up.sql\nCREATE TABLE users (\n    id SERIAL PRIMARY KEY,\n    name VARCHAR(255) NOT NULL,\n    created_at TIMESTAMP DEFAULT NOW()\n);\n```\n\n```sql\n-- 001_create_users.down.sql\nDROP TABLE IF EXISTS users;\n```\n\n```sql\n-- 002_add_email_to_users.up.sql\nALTER TABLE users ADD COLUMN email VARCHAR(255);\n```\n\n```sql\n-- 002_add_email_to_users.down.sql\nALTER TABLE users DROP COLUMN email;\n```\n\n## Инструмент: golang-migrate\n\nСамый популярный инструмент для миграций в Go — **golang-migrate**.\n\n### Установка\n\n```bash\ngo install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest\n```\n\n### Создание миграции\n\n```bash\nmigrate create -ext sql -dir migrations -seq add_orders_table\n```\n\nСоздаст два файла: `000003_add_orders_table.up.sql` и `000003_add_orders_table.down.sql`.\n\n### Применение\n\n```bash\n# Применить все новые миграции\nmigrate -path migrations -database \"postgres://user:pass@localhost:5432/mydb?sslmode=disable\" up\n\n# Откатить последнюю миграцию\nmigrate -path migrations -database \"...\" down 1\n\n# Посмотреть текущую версию\nmigrate -path migrations -database \"...\" version\n```\n\n## Миграции из кода\n\nМожно запускать миграции при старте приложения (удобно для Docker).\n\n```go\nimport (\n    \"github.com/golang-migrate/migrate/v4\"\n    _ \"github.com/golang-migrate/migrate/v4/database/postgres\"\n    _ \"github.com/golang-migrate/migrate/v4/source/file\"\n)\n\nfunc runMigrations(dbURL string) error {\n    m, err := migrate.New(\"file://migrations\", dbURL)\n    if err != nil {\n        return err\n    }\n\n    if err := m.Up(); err != nil && err != migrate.ErrNoChange {\n        return err\n    }\n\n    fmt.Println(\"Миграции применены\")\n    return nil\n}\n```\n\n## Правила работы с миграциями\n\n1. **Никогда не редактируйте** уже примененную миграцию. Если нужно изменить таблицу — создайте новую миграцию.\n2. **Всегда пишите down-миграцию**. Это страховка: можно откатить изменения, если что-то пошло не так.\n3. **Коммитьте миграции в Git**. Они — часть кода приложения.\n4. **Тестируйте миграции**: применил up, потом down, потом снова up. Если не сломалось — всё ок.\n\n## Итог\n\n1. Миграции — это версионирование структуры БД.\n2. Каждое изменение — отдельный файл (up + down).\n3. Используйте `golang-migrate` для управления миграциями.\n4. Никогда не меняйте таблицы руками на продакшене — только через миграции.\n"}